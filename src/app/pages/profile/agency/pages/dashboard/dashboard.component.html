<section class="agency-dashboard">
  <header class="dashboard-header">
    <div>
      <p class="eyebrow">Agentlik paneli</p>
      <h1>E'lonlarni boshqarish</h1>
      <p class="description">
        Agentligingizdagi barcha xodimlar tomonidan yaratilgan e’lonlarni ko‘rish va nazorat qilish.
      </p>
    </div>
    <button
      pButton
      type="button"
      [routerLink]="'/profile/create'"
      class="btn rounded-xl bg-[--green] text-white px-6 py-3 text-sm font-semibold"
    >
      Yangi e'lon qo'shish
    </button>
  </header>

  <section class="agency-context">
    <ng-container *ngIf="membershipsLoading">
      <div class="skeleton-group">
        <p-skeleton height="48px"></p-skeleton>
        <p-skeleton height="38px"></p-skeleton>
      </div>
    </ng-container>

    <ng-container *ngIf="!membershipsLoading && memberships.length === 0">
      <div class="empty-state">
        <h3>Agentlik topilmadi</h3>
        <p>
          Siz hali hech qanday agentlikka ulanmagansiz. Administrator sizni agentlikka qo‘shgandan so‘ng bu sahifa faollashadi.
        </p>
      </div>
    </ng-container>

    <div class="agency-selector" *ngIf="!membershipsLoading && memberships.length > 0">
      <div class="info-cards">
        <div class="info-card">
          <p>Agentlik</p>
          <h4>{{ activeMembership?.agency?.name }}</h4>
        </div>
        <div class="info-card">
          <p>Rol</p>
          <h4>{{ activeMembership?.role === 'owner' ? 'Owner' : 'Staff' }}</h4>
        </div>
        <div class="info-card" [ngClass]="{ inactive: !activeMembership?.agency?.is_active }">
          <p>Holat</p>
          <h4>{{ activeMembership?.agency?.is_active ? 'Aktiv' : 'O‘chirilgan' }}</h4>
        </div>
      </div>
    </div>
  </section>

  <section class="stats-panel" *ngIf="memberships.length > 0">
    <ng-container *ngIf="statsLoading">
      <div class="skeleton-group mt-2">
        <p-skeleton height="140px" width="100%"></p-skeleton>
      </div>
    </ng-container>

    <ng-container *ngIf="!statsLoading && stats as data; else statsFallback">
      <div class="stats-header">
        <div>
          <p class="eyebrow">Statistika</p>
          <h2>{{ data.range_label }}</h2>
          <p class="description">Tanlangan davr uchun ko‘rish va ko‘rsatishlar</p>
        </div>
        <div class="range-buttons">
          <button
            *ngFor="let key of summaryOrder"
            pButton
            type="button"
            [label]="getRangeLabel(key)"
            [class.active]="key === activeRange"
            (click)="selectRange(key)"
          ></button>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <p>Tanlangan davr</p>
          <h3>{{ data.range_views || 0 }}</h3>
          <span>ko‘rishlar</span>
        </div>
        <div class="metric-card">
          <p>Filtr ko‘rsatishlari</p>
          <h3>{{ data.range_exposures?.filter || 0 }}</h3>
          <span>Natijalar ro‘yxati</span>
        </div>
        <div class="metric-card">
          <p>Tavsiyalar</p>
          <h3>{{ data.range_exposures?.recommendation || 0 }}</h3>
          <span>Rekomendatsiya bloklari</span>
        </div>
        <div class="metric-card">
          <p>Jami ko‘rsatishlar</p>
          <h3>{{ data.range_exposures?.total || 0 }}</h3>
          <span>Filtr + tavsiya</span>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="card-header">
            <div>
              <h3>Ko‘rishlar dinamikasi</h3>
              <p class="description">Bugungi, 7 va 30 kunlik taqqoslash</p>
            </div>
          </div>
          <div class="chart-wrapper" *ngIf="viewsChartData; else noViews">
            <p-chart type="bar" [data]="viewsChartData" [options]="viewsChartOptions"></p-chart>
          </div>
          <ng-template #noViews>
            <div class="empty-state">
              <p>Ko‘rishlar topilmadi.</p>
            </div>
          </ng-template>
        </div>
        <div class="chart-card">
          <div class="card-header">
            <div>
              <h3>Ko‘rsatishlar manbasi</h3>
              <p class="description">Filtr va tavsiya ulushi</p>
            </div>
          </div>
          <div class="chart-wrapper" *ngIf="exposureChartData; else noExposures">
            <p-chart type="doughnut" [data]="exposureChartData" [options]="exposureChartOptions"></p-chart>
          </div>
          <ng-template #noExposures>
            <div class="empty-state">
              <p>Ko‘rsatishlar mavjud emas.</p>
            </div>
          </ng-template>
        </div>
      </div>

      <div class="top-card">
        <div class="card-header">
          <div>
            <h3>Eng aktiv e'lonlar</h3>
            <p class="description">Top 5 e’lon bo‘yicha ko‘rish va ko‘rsatishlar</p>
          </div>
        </div>
        <div class="chart-wrapper" *ngIf="topAnnouncementsChartData; else noTop">
          <p-chart type="bar" [data]="topAnnouncementsChartData" [options]="topAnnouncementsChartOptions"></p-chart>
        </div>
        <ng-template #noTop>
          <div class="empty-state">
            <p>Hozircha e’lonlar bo‘yicha statistika mavjud emas.</p>
          </div>
        </ng-template>
        <ul class="top-list" *ngIf="topAnnouncementsList.length">
          <li *ngFor="let item of topAnnouncementsList; index as idx">
            <span>{{ idx + 1 }}.</span>
            <div>
              <strong>{{ item.title }}</strong>
              <small>{{ item.views }} ko‘rish • {{ item.filter_exposures || 0 }} filtr • {{
                item.recommendation_exposures || 0
              }} tavsiya</small>
            </div>
          </li>
        </ul>
      </div>
    </ng-container>

    <ng-template #statsFallback>
      <div class="empty-state">
        <p>{{ statsError || 'Statistikani ko‘rish uchun agentlikka ulanishingiz kerak.' }}</p>
      </div>
    </ng-template>
  </section>

</section>
